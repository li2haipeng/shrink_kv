from modeling_llama import LlamaForCausalLM
from transformers import AutoTokenizer
import torch
import os
import pandas as pd


# os.environ["CUDA_VISIBLE_DEVICES"]="0"
txt = "Speaker 4: Thank you. And can we do the functions for content? Items I believe are 11, three, 14, 16 and 28, I believe.\nSpeaker 0: Item 11 is a communication from Council on Price recommendation to increase appropriation in the general fund group in the City Manager Department by $200 to provide a contribution to the Friends of the Long Beach Public Library. Item 12 is communication from Councilman Super Now. Recommendation to increase appropriation in the special advertising and promotion fund group and the city manager's department by $10,000 to provide support for the end of summer celebration. Item 13 is a communication from Councilman Austin. Recommendation to increase appropriation in the general fund group in the city manager department by $500 to provide a donation to the Jazz Angels . Item 14 is a communication from Councilman Austin. Recommendation to increase appropriation in the general fund group in the City Manager department by $300 to provide a donation to the Little Lion Foundation. Item 16 is a communication from Councilman Allen recommendation to increase appropriation in the general fund group in the city manager department by $1,020 to provide contribution to Casa Korero, Sew Feria Business Association, Friends of Long Beach Public Library and Dave Van Patten. Item 28 is a communication. Communication from Vice Mayor Richardson and Council Member Muranga. Recommendation to increase appropriation in the general fund group in the City Manager Department by $1,000 to provide a donation to Ron Palmer Summit. Basketball and Academic Camp.\n"
# txt = """John: So, um, I've been thinking about the project, you know, and I believe we need to, uh, make some changes. I mean, we want the project to succeed, right? So, like, I think we should consider maybe revising the timeline.
#     Sarah: I totally agree, John. I mean, we have to be realistic, you know. The timeline is, like, too tight. You know what I mean? We should definitely extend it.
#     """
# txt =  "createmonth,amt,open_balance,vendor_name,cnt\\n202305,100,0,INNOVATIVE INC,1\\n202306,725,725,JET MICRO CORP,1\\n202306,59,59,SERVERSCAN,1\\n202305,160.5,0,ATT&T INTERNET,1\\n202306,160.5,160.5,ATT&T INTERNET,1\\n202304,59,59,SERVERSCAN,1\\n202304,151.5,0,Toner,1\\n202305,126,0,Toner,1\\n202305,184,0,Toner,3\\n202305,104.6,0,Toner,1\\n202304,51,0,Toner,1\\n202306,10,10,C.I.T.I,1\\n202305,718.04,0,PAYCHEX,1\\n202305,1.99,1.99,ONEDRIVE,1\\n202306,231.55,0,T3/OFFICE RECYCLING SOLUTIONS,2\\n202306,1.99,1.99,ONEDRIVE,1\\n202305,250,0,INNOVATIVE INC,1\\n202304,1.99,1.99,ONEDRIVE,1\\n202305,2310,0,SBD GROUP INC,1\\n202305,11236.72,0,BOFA,1\\n202304,325,0,Mesa Verde Consulting,1\\n202306,185,185,Mesa Verde Consulting,1\\n202305,10,0,TAYLOR LANZER,1\\n202306,49.13,49.13,COLOR IMAGING,1\\n202306,59.06,59.06,IMAGE STAR,2\\n202305,170.25,0,CARDSERVICE,1\\n202306,54.96,0,CARDSERVICE,3\\n202305,58.11,0,CARDSERVICE,2\\n202305,91.21,0,CARDSERVICE,1\\n202304,63.9,0,CARDSERVICE,1\\n202304,472.82,0,CARDSERVICE,2\\n202304,117.49,0,IMAGE STAR,1\\n202304,83.13,0,CARDSERVICE,2\\n202306,46.56,0,CARDSERVICE,1\\n202306,50.94,0,CARDSERVICE,2\\n202305,54.72,0,CARDSERVICE,2\\n202306,119.44,0,IMAGE STAR,1\\n202304,140.61,0,CARDSERVICE,2\\n202304,244.48,0,CARDSERVICE,1\\n202305,77.77,0,IMAGE STAR,1\\n202305,103.35,0,CARDSERVICE,1\\n202305,52.12,0,CARDSERVICE,1\\n202305,56.68,0,IMAGE STAR,1\\n202305,34.97,0,CARDSERVICE,1\\n202305,139.64,0,IMAGE STAR,1\\n202304,78.92,0,CARDSERVICE,1\\n202304,238.13,0,CARDSERVICE,1\\n202305,113.09,0,CLOVER TECH GROUP,2\\n202306,892.08,892.08,IMAGING SOLUTIONS DIRECT,2\\n202304,144.42,0,IMAGING SOLUTIONS DIRECT,2\\n202304,892.23,0,IMAGING SOLUTIONS DIRECT,4\\n202304,1221.68,0,IMAGING SOLUTIONS DIRECT,3\\n202306,816.07,816.07,IMAGING SOLUTIONS DIRECT,3\\n202305,1150.75,0,IMAGING SOLUTIONS DIRECT,2\\n202305,1580.03,0,IMAGING SOLUTIONS DIRECT,2\\n202305,834.07,0,IMAGING SOLUTIONS DIRECT,3\\n202305,110.65,0,IMAGING SOLUTIONS DIRECT,1\\n202305,206.3,0,IMAGING SOLUTIONS DIRECT,1\\n202305,641.9,0,Toner,4\\n202305,96,0,Toner,1\\n202304,814.2,0,Toner,1\\n202306,51,51,Toner,1\\n202305,129,0,Toner,1\\n202306,64,64,Toner,1\\n202304,229,0,Toner,1\\n202306,67.4,67.4,Toner,1\\n202304,159,0,Toner,1\\n202304,620,0,Toner,1\\n202306,664,664,Toner,2\\n202304,685,0,Toner,2\\n202306,89,89,Toner,1\\n202305,407.3,0,Toner,2\\n202305,620,0,Toner,1\\n202306,452.46,0,PAYCHEX,1\\n202304,603.26,0,PAYCHEX,1\\n202304,505.64,0,PAYCHEX,1\\n202305,867.13,0,PAYCHEX,1\\n202305,10,10,C.I.T.I,1\\n202304,10,0,C.I.T.I,1\\n202304,154.45,0,ATT&T INTERNET,1\\n202305,59,59,SERVERSCAN,1\\n202306,418,0,KKG,1\\n202304,900,0,PLUMTREE GROUPPHASER 3 DIGITAL,1\\n202306,60,0,KKG,1\\n202306,456,0,KKG,1\\n202305,532,0,KKG,1\\n202306,380,0,KKG,1\\n202304,255,0,TERESA ABBOTTS,1\\n202304,391.67,0,TRUSTPILOT,1\\n202305,325,0,Mesa Verde Consulting,1\\n202305,391.67,0.02,TRUSTPILOT,1\\n202306,325,325,Mesa Verde Consulting,1\\n202304,2113.04,0,CLOVER TECH GROUP,2\\n202304,219.95,219.95,TRANSAMERICA,2\\n202305,109.23,0,CLOVER TECH GROUP,1\\n202304,151.61,0,ARETE OFFICE,2\\n202305,43.85,0,CLOVER TECH GROUP,1\\n202306,219.95,219.95,TRANSAMERICA,2\\n202304,114.06,0,CLOVER TECH GROUP,1\\n202305,264.13,0,CLOVER TECH GROUP,1\\n202305,219.95,219.95,TRANSAMERICA,2\\n202305,25,25,AUTHORIZENET,1\\n202304,49,0,BOFA,1\\n202306,11044.22,9113,BOFA,1\\n202306,2310,2310,SBD GROUP INC,1\\n202306,25,25,AUTHORIZENET,1\\n202304,12818.94,0,BOFA,1\\n202304,25,25,AUTHORIZENET,1\\n202306,49,49,BOFA,1\\n202305,49,0,BOFA,1\\n202304,2310,0,SBD GROUP INC,1\\n202306,508.07,508.07,NUWORLD BUSINESS SYSTEMS,1\\n202304,41.1,0,NUWORLD BUSINESS SYSTEMS,1\\n202306,280.92,0,SUPPLY WHOLESALER,2\\n202305,76,0,LIBERTY LASER SOLUTIONS,1\\n202305,939.51,0,SUPPLY WHOLESALER,12\\n202306,147.51,147.51,SUPPLY WHOLESALER,5\\n202306,248.43,0,SUPPLY WHOLESALER,5\\n202304,217.63,0,SUPPLY WHOLESALER,4\\n202305,515,0,LIBERTY LASER SOLUTIONS,3\\n202305,158.5,0,LIBERTY LASER SOLUTIONS,1\\n202304,605.57,0,SUPPLY WHOLESALER,11\\n202304,52.45,0,SUPPLY WHOLESALER,2\\n202304,77.94,0,SUPPLY WHOLESALER,3\\n202304,229.35,0,SUPPLY WHOLESALER,5\\n202306,16.94,16.94,SUPPLY WHOLESALER,1\\n202306,195.65,195.65,LIBERTY LASER SOLUTIONS,2\\n202306,92.39,92.39,SUPPLY WHOLESALER,2\\n202306,196,196,LIBERTY LASER SOLUTIONS,1\\n202306,1066.39,1066.39,SUPPLY WHOLESALER,6\\n202305,293.55,0,SUPPLY WHOLESALER,6\\n202304,483.56,0,SUPPLY WHOLESALER,8\\n202304,191.62,0,SUPPLY WHOLESALER,4\\n202306,104.76,104.76,SUPPLY WHOLESALER,1\\n202306,17.85,17.85,SUPPLY WHOLESALER,1\\n202306,101.38,101.38,SUPPLY WHOLESALER,1\\n202306,70,70,JG,1\\n202305,20.05,0,SUPPLY WHOLESALER,1\\n202305,36.34,0,SUPPLY WHOLESALER,1\\n202306,62,62,LIBERTY LASER SOLUTIONS,1\\n202304,300,300,MISC VENDOR,1\\n202305,300,300,MISC VENDOR,1\\n202306,300,300,MISC VENDOR,1\\n202304,12818.94,0,BOFA,1\\n202304,25,25,AUTHORIZENET,1\\n202306,49,49,BOFA,1\\n202305,49,0,BOFA,1\\n202304,2310,0,SBD GROUP INC,1\\n202306,508.07,508.07,NUWORLD BUSINESS SYSTEMS,1\\n202304,41.1,0,NUWORLD BUSINESS SYSTEMS,1\\n202306,280.92,0,SUPPLY WHOLESALER,2\\n202305,76,0,LIBERTY LASER SOLUTIONS,1\\n202305,939.51,0,SUPPLY WHOLESALER,12\\n202306,147.51,147.51,SUPPLY WHOLESALER,5\\n202306,248.43,0,SUPPLY WHOLESALER,5\\n202304,217.63,0,SUPPLY WHOLESALER,4\\n202305,515,0,LIBERTY LASER SOLUTIONS,3\\n202305,158.5,0,LIBERTY LASER SOLUTIONS,1\\n202304,605.57,0,SUPPLY WHOLESALER,11\\n202304,52.45,0,SUPPLY WHOLESALER,2\\n202304,77.94,0,SUPPLY WHOLESALER,3\\n202304,229.35,0,SUPPLY WHOLESALER,5\\n202306,16.94,16.94,SUPPLY WHOLESALER,1\\n202306,195.65,195.65,LIBERTY LASER SOLUTIONS,2\\n202306,92.39,92.39,SUPPLY WHOLESALER,2\\n202306,196,196,LIBERTY LASER SOLUTIONS,1\\n202306,1066.39,1066.39,SUPPLY WHOLESALER,6\\n202305,293.55,0,SUPPLY WHOLESALER,6\\n202304,483.56,0,SUPPLY WHOLESALER,8\\n202304,191.62,0,SUPPLY WHOLESALER,4\\n202306,104.76,104.76,SUPPLY WHOLESALER,1\\n202306,17.85,17.85,SUPPLY WHOLESALER,1\\n202306,101.38,101.38,SUPPLY WHOLESALER,1\\n202306,70,70,JG,1\\n202305,20.05,0,SUPPLY WHOLESALER,1\\n202305,36.34,0,SUPPLY WHOLESALER,1\\n202306,62,62,LIBERTY LASER SOLUTIONS,1\\n202304,300,300,MISC VENDOR,1\\n202305,300,300,MISC VENDOR,1\\n202306,300,300,MISC VENDOR,1\\n based on data above, list all expenses for 202305?"
# txt =  "createmonth,amt,open_balance,vendor_name,cnt\\n202305,100,0,INNOVATIVE INC,1\\n202306,725,725,JET MICRO CORP,1\\n202306,59,59,SERVERSCAN,1\\n202305,160.5,0,ATT&T INTERNET,1\\n202306,160.5,160.5,ATT&T INTERNET,1\\n202304,59,59,SERVERSCAN,1\\n202304,151.5,0,Toner,1\\n202305,126,0,Toner,1\\n202305,184,0,Toner,3\\n202305,104.6,0,Toner,1\\n202304,51,0,Toner,1\\n202306,10,10,C.I.T.I,1\\n202305,718.04,0,PAYCHEX,1\\n202305,1.99,1.99,ONEDRIVE,1\\n202306,231.55,0,T3/OFFICE RECYCLING SOLUTIONS,2\\n202306,1.99,1.99,ONEDRIVE,1\\n202305,250,0,INNOVATIVE INC,1\\n202304,1.99,1.99,ONEDRIVE,1\\n202305,2310,0,SBD GROUP INC,1\\n202305,11236.72,0,BOFA,1\\n202304,325,0,Mesa Verde Consulting,1\\n202306,185,185,Mesa Verde Consulting,1\\n202305,10,0,TAYLOR LANZER,1\\n202306,49.13,49.13,COLOR IMAGING,1\\n202306,59.06,59.06,IMAGE STAR,2\\n202305,170.25,0,CARDSERVICE,1\\n202306,54.96,0,CARDSERVICE,3\\n202305,58.11,0,CARDSERVICE,2\\n202305,91.21,0,CARDSERVICE,1\\n202304,63.9,0,CARDSERVICE,1\\n202304,472.82,0,CARDSERVICE,2\\n202304,117.49,0,IMAGE STAR,1\\n202304,83.13,0,CARDSERVICE,2\\n202306,46.56,0,CARDSERVICE,1\\n202306,50.94,0,CARDSERVICE,2\\n202305,54.72,0,CARDSERVICE,2\\n202306,119.44,0,IMAGE STAR,1\\n202304,140.61,0,CARDSERVICE,2\\n202304,244.48,0,CARDSERVICE,1\\n202305,77.77,0,IMAGE STAR,1\\n202305,103.35,0,CARDSERVICE,1\\n202305,52.12,0,CARDSERVICE,1\\n202305,56.68,0,IMAGE STAR,1\\n202305,34.97,0,CARDSERVICE,1\\n202305,139.64,0,IMAGE STAR,1\\n202304,78.92,0,CARDSERVICE,1\\n202304,238.13,0,CARDSERVICE,1\\n202305,113.09,0,CLOVER TECH GROUP,2\\n202306,892.08,892.08,IMAGING SOLUTIONS DIRECT,2\\n202304,144.42,0,IMAGING SOLUTIONS DIRECT,2\\n202304,892.23,0,IMAGING SOLUTIONS DIRECT,4\\n202304,1221.68,0,IMAGING SOLUTIONS DIRECT,3\\n202306,816.07,816.07,IMAGING SOLUTIONS DIRECT,3\\n202305,1150.75,0,IMAGING SOLUTIONS DIRECT,2\\n202305,1580.03,0,IMAGING SOLUTIONS DIRECT,2\\n202305,834.07,0,IMAGING SOLUTIONS DIRECT,3\\n202305,110.65,0,IMAGING SOLUTIONS DIRECT,1\\n202305,206.3,0,IMAGING SOLUTIONS DIRECT,1\\n202305,641.9,0,Toner,4\\n202305,96,0,Toner,1\\n202304,814.2,0,Toner,1\\n202306,51,51,Toner,1\\n202305,129,0,Toner,1\\n202306,64,64,Toner,1\\n202304,229,0,Toner,1\\n202306,67.4,67.4,Toner,1\\n202304,159,0,Toner,1\\n202304,620,0,Toner,1\\n202306,664,664,Toner,2\\n202304,685,0,Toner,2\\n based on data above, list all expenses for 202305?"

# model_id = "/home/ubuntu/suzuka_models/suzuka-73M"
# model_id = "/home/ubuntu/suzuka_models/suzuka-llama3-220M"
model_id = "/home/ubuntu/Llama3/Meta-Llama-3-70B-Instruct"
# model_id = "/home/ubuntu/Llama-2-7B-chat-hf"
# model_id = "/home/ubuntu/suzuka_models/suzuka-120M"
model = LlamaForCausalLM.from_pretrained(model_id, torch_dtype=torch.bfloat16, device_map="auto")
tokenizer = AutoTokenizer.from_pretrained(model_id)
inputs = tokenizer.encode(txt, return_tensors="pt")

tokens = tokenizer.batch_decode(inputs)
print(inputs.size())

outputs = model.generate(
        input_ids=inputs.to(model.device),
        max_new_tokens=1, 
        output_attentions = True
    )
print(tokenizer.batch_decode(outputs))

attn_weight = pd.read_csv("/home/ubuntu/shrink_kv/results/llama3_70B/seq_0_layer.csv", header=0)
t_list = []
for i in range(inputs.size(1)):
    t = tokenizer.decode(inputs[0,i])
    # print(t)
    t_list.append(t)
assert len(t_list) == attn_weight.shape[0]
attn_weight["token"] = t_list
attn_weight.to_csv("test.csv")